# 2022-03-14 - Fixed Mutation Rates - Landscape analyses

## Setup

```{r}
experiment_slug <- "2022-03-14-fixed-mut"
working_directory <- paste0("experiments/",experiment_slug,"/analysis/")
```

### Analysis dependencies

Load all required R libraries

```{r}
library(tidyverse)
library(ggplot2)
library(scales)
library(cowplot)
library(RColorBrewer)
source("https://gist.githubusercontent.com/benmarwick/2a1bb0133ff568cbe28d/raw/fb53bd97121f7f9ce947837ef1a4c65a73bffb3f/geom_flat_violin.R")
```

These analyses were knit with the following environment:

```{r}
print(version)
```

### Load data

Load 1-step landscape data
```{r}
ls1_run_summary_data_loc <- paste0(working_directory, "data/landscape_run_summary_step-1.csv")
ls1_run_summary_data <- read.csv(ls1_run_summary_data_loc, na.strings="NONE")

ls1_run_summary_data$COPY_MUT_PROB <- as.factor(
  ls1_run_summary_data$COPY_MUT_PROB
)
ls1_run_summary_data$env_chg_rate <- factor(
  ls1_run_summary_data$env_chg_rate,
  levels=c(
    "none",
    "30",
    "300",
    "3000"
  )
)
ls1_run_summary_data$env_condition <- as.factor(
  ls1_run_summary_data$env_condition
)
ls1_run_summary_data$env_type <- as.factor(
  ls1_run_summary_data$env_type
)

```

Load 1-step task co-occurrence data.
```{r}
ls1_cooccur_data_loc <- paste0(working_directory, "data/landscape_task_cooccurrence_treatment_summary_step-1.csv")
ls1_cooccur_data <- read.csv(ls1_cooccur_data_loc, na.strings="NONE")

ls1_cooccur_data$COPY_MUT_PROB <- as.factor(
  ls1_cooccur_data$COPY_MUT_PROB
)
ls1_cooccur_data$env_chg_rate <- as.factor(
  ls1_cooccur_data$env_chg_rate
)
ls1_cooccur_data$env_condition <- as.factor(
  ls1_cooccur_data$env_condition
)
ls1_cooccur_data$env_type <- as.factor(
  ls1_cooccur_data$env_type
)
ls1_cooccur_data$task_1_id <- as.factor(
  ls1_cooccur_data$task_1_id
)
ls1_cooccur_data$task_2_id <- as.factor(
  ls1_cooccur_data$task_2_id
)
```

Load 2-step landscape data
```{r}
ls2_run_summary_data_loc <- paste0(working_directory, "data/landscape_run_summary_step-2.csv")
ls2_run_summary_data <- read.csv(ls2_run_summary_data_loc, na.strings="NONE")

ls2_run_summary_data$COPY_MUT_PROB <- as.factor(
  ls2_run_summary_data$COPY_MUT_PROB
)
ls2_run_summary_data$env_chg_rate <- as.factor(
  ls2_run_summary_data$env_chg_rate
)
ls2_run_summary_data$env_condition <- as.factor(
  ls2_run_summary_data$env_condition
)
ls2_run_summary_data$env_type <- as.factor(
  ls2_run_summary_data$env_type
)
```

Load 2-step task co-occurrence data.
```{r}
ls2_cooccur_data_loc <- paste0(working_directory, "data/landscape_task_cooccurrence_treatment_summary_step-2.csv")
ls2_cooccur_data <- read.csv(ls2_cooccur_data_loc, na.strings="NONE")

ls2_cooccur_data$COPY_MUT_PROB <- as.factor(
  ls2_cooccur_data$COPY_MUT_PROB
)
ls2_cooccur_data$env_chg_rate <- as.factor(
  ls2_cooccur_data$env_chg_rate
)
ls2_cooccur_data$env_condition <- as.factor(
  ls2_cooccur_data$env_condition
)
ls2_cooccur_data$env_type <- as.factor(
  ls2_cooccur_data$env_type
)
ls2_cooccur_data$task_1_id <- as.factor(
  ls2_cooccur_data$task_1_id
)
ls2_cooccur_data$task_2_id <- as.factor(
  ls2_cooccur_data$task_2_id
)
```

Load run summary data

```{r}
summary_data_loc <- paste0(working_directory, "data/aggregate.csv")
summary_data <- read.csv(summary_data_loc, na.strings="NONE")

summary_data$COPY_MUT_PROB <- as.factor(
  summary_data$COPY_MUT_PROB
)
summary_data$env_chg_rate <- as.factor(
  summary_data$env_chg_rate
)
summary_data$env_condition <- as.factor(
  summary_data$env_condition
)
summary_data$env_type <- as.factor(
  summary_data$env_type
)

# Add final mutation rate to landscape summary data
get_final_mut_rate <- function(seed) {
  filtered_data <- filter(summary_data, RANDOM_SEED==seed)
  return(filtered_data$final_average_copy_mutation_rate)
}
ls1_run_summary_data$final_average_copy_mutation_rate <- mapply(
  get_final_mut_rate,
  ls1_run_summary_data$RANDOM_SEED
)
ls2_run_summary_data$final_average_copy_mutation_rate <- mapply(
  get_final_mut_rate,
  ls2_run_summary_data$RANDOM_SEED
)

get_env_chg_rate_label <- function(env_chg_rate, env_type) {
  if (env_chg_rate == "none" && env_type=="consta") {
    return("none-a")
  } else if (env_chg_rate == "none" && env_type=="constb") {
    return("none-b")
  } else if (env_chg_rate=="30") {
    return("30")
  } else if (env_chg_rate=="300") {
    return("300")
  } else if (env_chg_rate=="3000") {
    return("3000")
  } else {
    return("unknown")
  }
}
ls1_run_summary_data$env_chg_rate_label <- mapply(
  get_env_chg_rate_label,
  ls1_run_summary_data$env_chg_rate,
  ls1_run_summary_data$env_type
)
ls1_run_summary_data$env_chg_rate_label <- factor(
  ls1_run_summary_data$env_chg_rate_label,
  levels=c(
    "none-a",
    "none-b",
    "30",
    "300",
    "3000"
  )
)

get_env_type_label <- function(env_type) {
  if (env_type=="consta" || env_type=="constb" || env_type=="cycling") {
    return("cycling+const")
  } else if (env_type=="random") {
    return("random")
  }
}
ls1_run_summary_data$env_type_label <- mapply(
  get_env_type_label,
  ls1_run_summary_data$env_type
)
```

Miscellaneous setup.

```{r}
# Configure our default graphing theme
theme_set(theme_cowplot())
# Palette
cb_palette <- "Set2"
alpha <- 0.05
# Create a directory to store plots
plot_directory <- paste0(working_directory, "plots/")
dir.create(plot_directory, showWarnings=FALSE)
```

## Number of viable mutants

### 1-step mutants

```{r}
ggplot(
    ls1_run_summary_data,
    aes(
      x=env_chg_rate,
      y=prop_viable,
      fill=env_chg_rate
    )
  ) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8,
    adjust=1.5
  ) +
  geom_point(
    mapping=aes(color=env_chg_rate),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  scale_fill_brewer(
    palette=cb_palette
  ) +
  scale_color_brewer(
    palette=cb_palette
  ) +
  facet_grid(
    env_type~COPY_MUT_PROB
  ) +
  theme(
    legend.position="none",
    axis.text.x = element_text(angle = 90),
    panel.border = element_rect(color = "grey", fill=NA, size=2)
  )

ggsave(
  paste0(working_directory, "plots/", "prop_viable_mutants_step-1.pdf")
)
```

### 2-step mutants

```{r}
ggplot(
    ls2_run_summary_data,
    aes(
      x=env_condition,
      y=prop_viable,
      fill=env_condition
    )
  ) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8,
    adjust=1.5
  ) +
  geom_point(
    mapping=aes(color=env_condition),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  scale_fill_brewer(
    palette=cb_palette
  ) +
  scale_color_brewer(
    palette=cb_palette
  ) +
  facet_wrap(
    ~COPY_MUT_PROB
  ) +
  theme(
    legend.position="none",
    axis.text.x = element_text(angle = 90),
    panel.border = element_rect(color = "grey", fill=NA, size=2)
  )

ggsave(
  paste0(working_directory, "plots/", "prob-viable-two-step-mutants.pdf")
)
```

## Number of unique phenotypes

### 1-step mutants

```{r}
ggplot(
    ls1_run_summary_data,
    aes(
      x=env_chg_rate,
      y=num_unique_viable_phenotypes,
      fill=env_chg_rate
    )
  ) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8,
    adjust=1.5
  ) +
  geom_point(
    mapping=aes(color=env_chg_rate),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  scale_fill_brewer(
    palette=cb_palette
  ) +
  scale_color_brewer(
    palette=cb_palette
  ) +
  facet_grid(
    env_type~COPY_MUT_PROB
  ) +
  theme(
    legend.position="none",
    axis.text.x = element_text(angle = 90),
    panel.border = element_rect(color = "grey", fill=NA, size=2)
  )

ggsave(
  paste0(working_directory, "plots/", "num_unique_viable_phenotypes_mutants_step-1.pdf")
)
```

### 2-step mutants

```{r}
ggplot(
    ls2_run_summary_data,
    aes(
      x=env_condition,
      y=num_unique_viable_phenotypes,
      fill=env_condition
    )
  ) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8,
    adjust=1.5
  ) +
  geom_point(
    mapping=aes(color=env_condition),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  scale_fill_brewer(
    palette=cb_palette
  ) +
  scale_color_brewer(
    palette=cb_palette
  ) +
  facet_wrap(
    ~COPY_MUT_PROB
  ) +
  theme(
    legend.position="none",
    axis.text.x = element_text(angle = 90),
    panel.border = element_rect(color = "grey", fill=NA, size=2)
  )

ggsave(
  paste0(working_directory, "plots/", "num-phenotypes-two-step-mutants.pdf")
)
```

## Entropy of phenotypes

### 1-step mutants

```{r}
ggplot(
    ls1_run_summary_data,
    aes(
      x=env_chg_rate,
      y=entropy_viable_phenotypes,
      fill=env_chg_rate
    )
  ) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8,
    adjust=1.5
  ) +
  geom_point(
    mapping=aes(color=env_chg_rate),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  scale_fill_brewer(
    palette=cb_palette
  ) +
  scale_color_brewer(
    palette=cb_palette
  ) +
  facet_grid(
    COPY_MUT_PROB~env_type
  ) +
  theme(
    legend.position="none",
    axis.text.x = element_text(angle = 90),
    panel.border = element_rect(color = "grey", fill=NA, size=2)
  )

ggsave(
  paste0(working_directory, "plots/", "entropy_viable_phenotypes_mutants_step-1.pdf")
)
```

### 2-step mutants

```{r}
ggplot(
    ls2_run_summary_data,
    aes(
      x=env_condition,
      y=entropy_viable_phenotypes,
      fill=env_condition
    )
  ) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8,
    adjust=1.5
  ) +
  geom_point(
    mapping=aes(color=env_condition),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  scale_fill_brewer(
    palette=cb_palette
  ) +
  scale_color_brewer(
    palette=cb_palette
  ) +
  facet_wrap(
    ~COPY_MUT_PROB
  ) +
  theme(
    legend.position="none",
    axis.text.x = element_text(angle = 90),
    panel.border = element_rect(color = "grey", fill=NA, size=2)
  )

ggsave(
  paste0(working_directory, "plots/", "entropy-phenotypes-two-step-mutants.pdf")
)
```

## Average distance to ancestor

### 1-step mutants

```{r}
ggplot(
    ls1_run_summary_data,
    aes(
      x=env_chg_rate,
      y=avg_dist_to_ancestor,
      fill=env_chg_rate
    )
  ) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8,
    adjust=1.5
  ) +
  geom_point(
    mapping=aes(color=env_chg_rate),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  scale_fill_brewer(
    palette=cb_palette
  ) +
  scale_color_brewer(
    palette=cb_palette
  ) +
  facet_grid(
    COPY_MUT_PROB~env_type
  ) +
  theme(
    legend.position="none",
    axis.text.x = element_text(angle = 90),
    panel.border = element_rect(color = "grey", fill=NA, size=2)
  )
ggsave(
  paste0(working_directory, "plots/", "avg_dist_to_ancestor_mutants_step-1.pdf")
)
```

### 2-step mutants

```{r}
ggplot(
    ls2_run_summary_data,
    aes(
      x=env_condition,
      y=avg_dist_to_ancestor,
      fill=env_condition
    )
  ) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8,
    adjust=1.5
  ) +
  geom_point(
    mapping=aes(color=env_condition),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  scale_fill_brewer(
    palette=cb_palette
  ) +
  scale_color_brewer(
    palette=cb_palette
  ) +
  facet_wrap(
    ~COPY_MUT_PROB
  ) +
  theme(
    legend.position="none",
    axis.text.x = element_text(angle = 90),
    panel.border = element_rect(color = "grey", fill=NA, size=2)
  )
ggsave(
  paste0(working_directory, "plots/", "avg-dist-to-ancestor_mutants-step-2.pdf")
)
```

## Number of viable mutants that gain tasks

## 1-step mutants

```{r}
ggplot(
    ls1_run_summary_data,
    aes(
      x=env_chg_rate,
      y=num_viable_mutants_gain_tasks,
      fill=env_chg_rate
    )
  ) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8,
    adjust=1.5
  ) +
  geom_point(
    mapping=aes(color=env_chg_rate),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  scale_fill_brewer(
    palette=cb_palette
  ) +
  scale_color_brewer(
    palette=cb_palette
  ) +
  facet_grid(
    COPY_MUT_PROB~env_type
  ) +
  theme(
    legend.position="none",
    axis.text.x = element_text(angle = 90),
    panel.border = element_rect(color = "grey", fill=NA, size=2)
  )
ggsave(
  paste0(working_directory, "plots/", "num_viable_mutants_gain_tasks_mutants_step-1.pdf")
)
```

### 2-step mutants

```{r}
ggplot(
    ls2_run_summary_data,
    aes(
      x=env_condition,
      y=num_viable_mutants_gain_tasks,
      fill=env_condition
    )
  ) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8,
    adjust=1.5
  ) +
  geom_point(
    mapping=aes(color=env_condition),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  scale_fill_brewer(
    palette=cb_palette
  ) +
  scale_color_brewer(
    palette=cb_palette
  ) +
  facet_wrap(
    ~COPY_MUT_PROB
  ) +
  theme(
    legend.position="none",
    axis.text.x = element_text(angle = 90),
    panel.border = element_rect(color = "grey", fill=NA, size=2)
  )
ggsave(
  paste0(working_directory, "plots/", "num-viable-gain-tasks_mutants-step-2.pdf")
)
```

## Number of viable mutants that lose tasks

### 1-step mutants

```{r}
ggplot(
    ls1_run_summary_data,
    aes(
      x=env_chg_rate,
      y=num_viable_mutants_lose_tasks,
      fill=env_chg_rate
    )
  ) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8,
    adjust=1.5
  ) +
  geom_point(
    mapping=aes(color=env_chg_rate),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  scale_fill_brewer(
    palette=cb_palette
  ) +
  scale_color_brewer(
    palette=cb_palette
  ) +
  facet_grid(
    COPY_MUT_PROB~env_type
  ) +
  theme(
    legend.position="none",
    axis.text.x = element_text(angle = 90),
    panel.border = element_rect(color = "grey", fill=NA, size=2)
  )
ggsave(
  paste0(working_directory, "plots/", "num_viable_mutants_lose_tasks_mutants_step-1.pdf")
)
```

```{r}
ggplot(
    ls1_run_summary_data,
    aes(
      x=env_chg_rate,
      y=num_viable_mutants_lose_multiple_tasks,
      fill=env_chg_rate
    )
  ) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8,
    adjust=1.5
  ) +
  geom_point(
    mapping=aes(color=env_chg_rate),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  scale_fill_brewer(
    palette=cb_palette
  ) +
  scale_color_brewer(
    palette=cb_palette
  ) +
  facet_grid(
    COPY_MUT_PROB~env_type
  ) +
  theme(
    legend.position="none",
    axis.text.x = element_text(angle = 90),
    panel.border = element_rect(color = "grey", fill=NA, size=2)
  )
ggsave(
  paste0(working_directory, "plots/", "num_viable_mutants_lose_multiple_tasks_mutants_step-1.pdf")
)
```

### 2-step mutants

```{r}

```

```{r}

```

## Average number of tasks lost

(when tasks are lost)

### 1-step mutants

```{r}
ggplot(
    ls1_run_summary_data,
    aes(
      x=env_chg_rate,
      y=avg_num_tasks_lost,
      fill=env_chg_rate
    )
  ) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8,
    adjust=1.5
  ) +
  geom_point(
    mapping=aes(color=env_chg_rate),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  scale_fill_brewer(
    palette=cb_palette
  ) +
  scale_color_brewer(
    palette=cb_palette
  ) +
  facet_grid(
    COPY_MUT_PROB~env_type
  ) +
  theme(
    legend.position="none",
    axis.text.x = element_text(angle = 90),
    panel.border = element_rect(color = "grey", fill=NA, size=2)
  )
ggsave(
  paste0(working_directory, "plots/", "avg_num_tasks_lost_mutants_step-1.pdf")
)
```

### 2-step mutants

```{r}

```

## Total NPMI

### 1-step mutants

```{r}
ggplot(
    ls1_run_summary_data,
    aes(
      x=env_chg_rate_label,
      y=total_npmi,
      fill=env_chg_rate_label
    )
  ) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8,
    adjust=1.5
  ) +
  geom_point(
    mapping=aes(color=env_chg_rate_label),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  scale_fill_brewer(
    palette=cb_palette
  ) +
  scale_color_brewer(
    palette=cb_palette
  ) +
  facet_grid(
    COPY_MUT_PROB~env_type_label
  ) +
  theme(
    legend.position="none",
    axis.text.x = element_text(angle = 90),
    panel.border = element_rect(color = "grey", fill=NA, size=2)
  )
ggsave(
  paste0(working_directory, "plots/", "total_npmi_mutants_step-1.pdf")
)
```

### 2-step mutants

```{r}

```

## Total unexpected NPMI

### 1-step mutants
```{r}
ggplot(
    ls1_run_summary_data,
    aes(
      x=env_chg_rate_label,
      y=unexpected_npmi,
      fill=env_chg_rate_label
    )
  ) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8,
    adjust=1.5
  ) +
  geom_point(
    mapping=aes(color=env_chg_rate_label),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  scale_fill_brewer(
    palette=cb_palette
  ) +
  scale_color_brewer(
    palette=cb_palette
  ) +
  facet_grid(
    COPY_MUT_PROB~env_type_label
  ) +
  theme(
    legend.position="none",
    axis.text.x = element_text(angle = 90),
    panel.border = element_rect(color = "grey", fill=NA, size=2)
  )
ggsave(
  paste0(working_directory, "plots/", "unexpected_npmi_mutants_step-1.pdf")
)
```

## Pointwise mutual information matrices

### 1-step mutants

```{r}
ggplot(
    ls1_cooccur_data,
    aes(
      x=task_1_id,
      y=task_2_id,
      fill=npmi_avg
    )
  ) +
  geom_tile() +
  scale_fill_distiller(
    palette = "RdBu",
    limits=c(-1.0, 1.0),
    breaks=c(-1, -0.5, 0.0, 0.5, 1.0)
  ) +
  facet_grid(
    env_condition~COPY_MUT_PROB
  ) +
  ggtitle("One-step Mutants") +
  theme(
    legend.position="bottom",
    strip.text.y=element_text(size=10),
    legend.key.width=unit(3, "cm")
  )
ggsave(
  paste0(working_directory, "plots/", "npmi_matrices_mutants_step-1.pdf"),
  height=15,
  width=12
)
```

### 2-step mutants

```{r}
```