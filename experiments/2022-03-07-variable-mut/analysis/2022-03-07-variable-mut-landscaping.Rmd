# 2022-03-07 - Variable Mutation Rates - Landscape analyses

## Setup

```{r}
experiment_slug <- "2022-03-07-variable-mut"
working_directory <- paste0("experiments/",experiment_slug,"/analysis/")
```

### Analysis dependencies

Load all required R libraries

```{r}
library(tidyverse)
library(ggplot2)
library(scales)
library(cowplot)
library(RColorBrewer)
library(viridis)
source("https://gist.githubusercontent.com/benmarwick/2a1bb0133ff568cbe28d/raw/fb53bd97121f7f9ce947837ef1a4c65a73bffb3f/geom_flat_violin.R")
```

These analyses were knit with the following environment:

```{r}
print(version)
```

### Load data

Load 1-step landscape data

```{r}
ls1_run_summary_data_loc <- paste0(working_directory, "data/landscape_run_summary_step-1.csv")
ls1_run_summary_data <- read.csv(ls1_run_summary_data_loc, na.strings="NONE")

ls1_run_summary_data$COPY_MUT_PROB <- as.factor(
  ls1_run_summary_data$COPY_MUT_PROB
)
ls1_run_summary_data$env_chg_rate <- as.factor(
  ls1_run_summary_data$env_chg_rate
)
ls1_run_summary_data$env_condition <- as.factor(
  ls1_run_summary_data$env_condition
)
ls1_run_summary_data$env_type <- as.factor(
  ls1_run_summary_data$env_type
)

get_env_chg_rate_label <- function(env_chg_rate, env_type) {
  if (env_chg_rate == "none" && env_type=="consta") {
    return("none-a")
  } else if (env_chg_rate == "none" && env_type=="constb") {
    return("none-b")
  } else if (env_chg_rate=="30") {
    return("30")
  } else if (env_chg_rate=="300") {
    return("300")
  } else if (env_chg_rate=="3000") {
    return("3000")
  } else {
    return("unknown")
  }
}
get_env_type_label <- function(env_type) {
  if (env_type=="consta" || env_type=="constb") {
    return("const")
  } else if (env_type=="cycling") {
    return("cycling")
  } else if (env_type=="random") {
    return("random")
  }
}
ls1_run_summary_data$env_chg_rate_label <- mapply(
  get_env_chg_rate_label,
  ls1_run_summary_data$env_chg_rate,
  ls1_run_summary_data$env_type
)
ls1_run_summary_data$env_chg_rate_label <- factor(
  ls1_run_summary_data$env_chg_rate_label,
  levels=c(
    "none-a",
    "none-b",
    "30",
    "300",
    "3000"
  )
)
ls1_run_summary_data$env_type_label <- mapply(
  get_env_type_label,
  ls1_run_summary_data$env_type
)
```

Load 1-step task co-occurrence data.
```{r}
ls1_cooccur_data_loc <- paste0(working_directory, "data/landscape_task_cooccurrence_treatment_summary_step-1.csv")
ls1_cooccur_data <- read.csv(ls1_cooccur_data_loc, na.strings="NONE")

ls1_cooccur_data$COPY_MUT_PROB <- as.factor(
  ls1_cooccur_data$COPY_MUT_PROB
)
ls1_cooccur_data$env_chg_rate <- as.factor(
  ls1_cooccur_data$env_chg_rate
)
ls1_cooccur_data$env_condition <- as.factor(
  ls1_cooccur_data$env_condition
)
ls1_cooccur_data$env_type <- as.factor(
  ls1_cooccur_data$env_type
)
ls1_cooccur_data$task_1_id <- as.factor(
  ls1_cooccur_data$task_1_id
)
ls1_cooccur_data$task_2_id <- as.factor(
  ls1_cooccur_data$task_2_id
)

ls1_cooccur_data$env_chg_rate_label <- mapply(
  get_env_chg_rate_label,
  ls1_cooccur_data$env_chg_rate,
  ls1_cooccur_data$env_type
)
ls1_cooccur_data$env_chg_rate_label <- factor(
  ls1_cooccur_data$env_chg_rate_label,
  levels=c(
    "none-a",
    "none-b",
    "30",
    "300",
    "3000"
  )
)
ls1_cooccur_data$env_type_label <- mapply(
  get_env_type_label,
  ls1_cooccur_data$env_type
)
```

Load 1-step mutant phenotype distance distributions

```{r}
ls1_phen_dists_data_loc <- paste0(working_directory, "data/mutant_phenotype_distances_step-1.csv")
ls1_phen_dists_data <- read.csv(ls1_phen_dists_data_loc, na.strings="NONE")

ls1_phen_dists_data$COPY_MUT_PROB <- as.factor(
  ls1_phen_dists_data$COPY_MUT_PROB
)
ls1_phen_dists_data$env_chg_rate <- as.factor(
  ls1_phen_dists_data$env_chg_rate
)
ls1_phen_dists_data$env_condition <- as.factor(
  ls1_phen_dists_data$env_condition
)
ls1_phen_dists_data$env_type <- as.factor(
  ls1_phen_dists_data$env_type
)
ls1_phen_dists_data$distance <- factor(
  ls1_phen_dists_data$distance,
  levels=c(
    -1,
    0,
    1,
    2,
    3,
    4,
    5,
    6
  )
)

# Hacky/inefficient way to assign rep_ids based on replicate_id ordering
ls1_simplify_replicate_id <- function(e, m, rep_id) {
  treatment_data <- filter(
    ls1_phen_dists_data,
    (env_condition==e) & (COPY_MUT_PROB==m)
  )
  rep_ids <- as.integer(levels(factor(treatment_data$replicate_id)))
  rep_id_map <- as.data.frame(rep_ids)
  rep_id_map$order <- order(rep_id_map$rep_ids)
  return(filter(rep_id_map, rep_ids==rep_id)$order)
}
ls1_phen_dists_data$rep_id <- mapply(
  ls1_simplify_replicate_id,
  ls1_phen_dists_data$env_condition,
  ls1_phen_dists_data$COPY_MUT_PROB,
  ls1_phen_dists_data$replicate_id
)
ls1_phen_dists_data$rep_id <- as.factor(
  ls1_phen_dists_data$rep_id
)


ls1_phen_dists_data$replicate_id <- as.factor(
  ls1_phen_dists_data$replicate_id
)
ls1_phen_dists_data$RANDOM_SEED <- as.factor(
  ls1_phen_dists_data$RANDOM_SEED
)

ls1_phen_dists_data$env_chg_rate_label <- mapply(
  get_env_chg_rate_label,
  ls1_phen_dists_data$env_chg_rate,
  ls1_phen_dists_data$env_type
)
ls1_phen_dists_data$env_chg_rate_label <- factor(
  ls1_phen_dists_data$env_chg_rate_label,
  levels=c(
    "none-a",
    "none-b",
    "30",
    "300",
    "3000"
  )
)
ls1_phen_dists_data$env_type_label <- mapply(
  get_env_type_label,
  ls1_phen_dists_data$env_type
)
```

Load 2-step landscape data

```{r}
ls2_run_summary_data_loc <- paste0(working_directory, "data/landscape_run_summary_step-2.csv")
ls2_run_summary_data <- read.csv(ls2_run_summary_data_loc, na.strings="NONE")

ls2_run_summary_data$COPY_MUT_PROB <- as.factor(
  ls2_run_summary_data$COPY_MUT_PROB
)
ls2_run_summary_data$env_chg_rate <- as.factor(
  ls2_run_summary_data$env_chg_rate
)
ls2_run_summary_data$env_condition <- as.factor(
  ls2_run_summary_data$env_condition
)
ls2_run_summary_data$env_type <- as.factor(
  ls2_run_summary_data$env_type
)

ls2_run_summary_data$env_chg_rate_label <- mapply(
  get_env_chg_rate_label,
  ls2_run_summary_data$env_chg_rate,
  ls2_run_summary_data$env_type
)
ls2_run_summary_data$env_chg_rate_label <- factor(
  ls2_run_summary_data$env_chg_rate_label,
  levels=c(
    "none-a",
    "none-b",
    "30",
    "300",
    "3000"
  )
)
ls2_run_summary_data$env_type_label <- mapply(
  get_env_type_label,
  ls2_run_summary_data$env_type
)
```

Load 2-step task co-occurrence data.
```{r}
ls2_cooccur_data_loc <- paste0(
  working_directory,
  "data/landscape_task_cooccurrence_treatment_summary_step-2.csv"
)
ls2_cooccur_data <- read.csv(ls2_cooccur_data_loc, na.strings="NONE")

ls2_cooccur_data$COPY_MUT_PROB <- as.factor(
  ls2_cooccur_data$COPY_MUT_PROB
)
ls2_cooccur_data$env_chg_rate <- as.factor(
  ls2_cooccur_data$env_chg_rate
)
ls2_cooccur_data$env_condition <- as.factor(
  ls2_cooccur_data$env_condition
)
ls2_cooccur_data$env_type <- as.factor(
  ls2_cooccur_data$env_type
)
ls2_cooccur_data$task_1_id <- as.factor(
  ls2_cooccur_data$task_1_id
)
ls2_cooccur_data$task_2_id <- as.factor(
  ls2_cooccur_data$task_2_id
)

ls2_cooccur_data$env_chg_rate_label <- mapply(
  get_env_chg_rate_label,
  ls2_cooccur_data$env_chg_rate,
  ls2_cooccur_data$env_type
)
ls2_cooccur_data$env_chg_rate_label <- factor(
  ls2_cooccur_data$env_chg_rate_label,
  levels=c(
    "none-a",
    "none-b",
    "30",
    "300",
    "3000"
  )
)
ls2_cooccur_data$env_type_label <- mapply(
  get_env_type_label,
  ls2_cooccur_data$env_type
)
```

Load 2-step phenotype distance distribution data

```{r}
ls2_phen_dists_data_loc <- paste0(working_directory, "data/mutant_phenotype_distances_step-2.csv")
ls2_phen_dists_data <- read.csv(ls2_phen_dists_data_loc, na.strings="NONE")

ls2_phen_dists_data$COPY_MUT_PROB <- as.factor(
  ls2_phen_dists_data$COPY_MUT_PROB
)
ls2_phen_dists_data$env_chg_rate <- as.factor(
  ls2_phen_dists_data$env_chg_rate
)
ls2_phen_dists_data$env_condition <- as.factor(
  ls2_phen_dists_data$env_condition
)
ls2_phen_dists_data$env_type <- as.factor(
  ls2_phen_dists_data$env_type
)

ls2_phen_dists_data$distance <- factor(
  ls2_phen_dists_data$distance,
  levels=c(
    -1,
    0,
    1,
    2,
    3,
    4,
    5,
    6
  )
)

# Hacky/inefficient way to assign rep_ids based on replicate_id ordering
ls2_simplify_replicate_id <- function(e, m, rep_id) {
  treatment_data <- filter(
    ls2_phen_dists_data,
    (env_condition==e) & (COPY_MUT_PROB==m)
  )
  rep_ids <- as.integer(levels(factor(treatment_data$replicate_id)))
  rep_id_map <- as.data.frame(rep_ids)
  rep_id_map$order <- order(rep_id_map$rep_ids)
  return(filter(rep_id_map, rep_ids==rep_id)$order)
}
ls2_phen_dists_data$rep_id <- mapply(
  ls2_simplify_replicate_id,
  ls2_phen_dists_data$env_condition,
  ls2_phen_dists_data$COPY_MUT_PROB,
  ls2_phen_dists_data$replicate_id
)
ls2_phen_dists_data$rep_id <- as.factor(
  ls2_phen_dists_data$rep_id
)

ls2_phen_dists_data$replicate_id <- as.factor(
  ls2_phen_dists_data$replicate_id
)
ls2_phen_dists_data$RANDOM_SEED <- as.factor(
  ls2_phen_dists_data$RANDOM_SEED
)

ls2_phen_dists_data$env_chg_rate_label <- mapply(
  get_env_chg_rate_label,
  ls2_phen_dists_data$env_chg_rate,
  ls2_phen_dists_data$env_type
)
ls2_phen_dists_data$env_chg_rate_label <- factor(
  ls2_phen_dists_data$env_chg_rate_label,
  levels=c(
    "none-a",
    "none-b",
    "30",
    "300",
    "3000"
  )
)
ls2_phen_dists_data$env_type_label <- mapply(
  get_env_type_label,
  ls2_phen_dists_data$env_type
)
```

Load run summary data

```{r}
summary_data_loc <- paste0(working_directory, "data/aggregate.csv")
summary_data <- read.csv(summary_data_loc, na.strings="NONE")

summary_data$COPY_MUT_PROB <- as.factor(
  summary_data$COPY_MUT_PROB
)
summary_data$env_chg_rate <- as.factor(
  summary_data$env_chg_rate
)
summary_data$env_condition <- as.factor(
  summary_data$env_condition
)
summary_data$env_type <- as.factor(
  summary_data$env_type
)

# Add final mutation rate to landscape summary data
get_final_mut_rate <- function(seed) {
  filtered_data <- filter(summary_data, RANDOM_SEED==seed)
  return(filtered_data$final_average_copy_mutation_rate)
}
ls1_run_summary_data$final_average_copy_mutation_rate <- mapply(
  get_final_mut_rate,
  ls1_run_summary_data$RANDOM_SEED
)
ls2_run_summary_data$final_average_copy_mutation_rate <- mapply(
  get_final_mut_rate,
  ls2_run_summary_data$RANDOM_SEED
)

get_dom_match_score_env_a <- function(seed) {
  filtered_data <- filter(summary_data, RANDOM_SEED==seed)
  return(filtered_data$dom_match_score_env_a)
}

ls2_phen_dists_data$dom_match_score_env_a <- mapply(
  get_dom_match_score_env_a,
  ls2_phen_dists_data$RANDOM_SEED
)
```

Miscellaneous setup.

```{r}
# Configure our default graphing theme
theme_set(theme_cowplot())
# Palette
cb_palette <- "Set2"
alpha <- 0.05
# Create a directory to store plots
plot_directory <- paste0(working_directory, "plots/")
dir.create(plot_directory, showWarnings=FALSE)
```

## Number of viable mutants

### 1-step mutants

```{r}
ggplot(
    ls1_run_summary_data,
    aes(
      x=env_chg_rate_label,
      y=prop_viable,
      fill=env_condition
    )
  ) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8,
    adjust=1.5
  ) +
  geom_point(
    mapping=aes(color=env_condition),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  scale_fill_brewer(
    palette=cb_palette
  ) +
  scale_color_brewer(
    palette=cb_palette
  ) +
  facet_grid(
    COPY_MUT_PROB~env_type_label,
    scales="free_x"
  ) +
  theme(
    legend.position="none",
    axis.text=element_text(size=14),
    # axis.text.x = element_text(angle = 90),
    panel.border = element_rect(color = "grey", fill=NA, size=1.5)
  )
ggsave(
  paste0(working_directory, "plots/", "prop_viable_mutants_step-1.pdf")
)
```

### 2-step mutants

```{r}
ggplot(
    ls2_run_summary_data,
    aes(
      x=env_chg_rate_label,
      y=prop_viable,
      fill=env_condition
    )
  ) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8,
    adjust=1.5
  ) +
  geom_point(
    mapping=aes(color=env_condition),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  scale_fill_brewer(
    palette=cb_palette
  ) +
  scale_color_brewer(
    palette=cb_palette
  ) +
  facet_grid(
    COPY_MUT_PROB~env_type_label,
    scales="free_x"
  ) +
  theme(
    legend.position="none",
    axis.text=element_text(size=14),
    # axis.text.x = element_text(angle = 90),
    panel.border = element_rect(color = "grey", fill=NA, size=1.5)
  )
ggsave(
  paste0(working_directory, "plots/", "prop_viable_mutants_step-2.pdf")
)
```

## Number of unique phenotypes

### 1-step mutants

```{r}
ggplot(
    ls1_run_summary_data,
    aes(
      x=env_chg_rate_label,
      y=num_unique_viable_phenotypes,
      fill=env_condition
    )
  ) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8,
    adjust=1.5
  ) +
  geom_point(
    mapping=aes(color=env_condition),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  scale_fill_brewer(
    palette=cb_palette
  ) +
  scale_color_brewer(
    palette=cb_palette
  ) +
  facet_grid(
    COPY_MUT_PROB~env_type_label,
    scales="free_x"
  ) +
  theme(
    legend.position="none",
    axis.text=element_text(size=14),
    panel.border = element_rect(color = "grey", fill=NA, size=1.5)
  )
ggsave(
  paste0(working_directory, "plots/", "num_unique_viable_phenotypes_step-1.pdf")
)
```

### 2-step mutants

```{r}
ggplot(
    ls2_run_summary_data,
    aes(
      x=env_chg_rate_label,
      y=num_unique_viable_phenotypes,
      fill=env_condition
    )
  ) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8,
    adjust=1.5
  ) +
  geom_point(
    mapping=aes(color=env_condition),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  scale_fill_brewer(
    palette=cb_palette
  ) +
  scale_color_brewer(
    palette=cb_palette
  ) +
  facet_grid(
    COPY_MUT_PROB~env_type_label,
    scales="free_x"
  ) +
  theme(
    legend.position="none",
    axis.text=element_text(size=14),
    panel.border = element_rect(color = "grey", fill=NA, size=1.5)
  )
ggsave(
  paste0(working_directory, "plots/", "num_unique_viable_phenotypes_step-2.pdf")
)
```

## Entropy of phenotypes

### 1-step mutants

```{r}
ggplot(
    ls1_run_summary_data,
    aes(
      x=env_chg_rate_label,
      y=entropy_viable_phenotypes,
      fill=env_condition
    )
  ) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8,
    adjust=1.5
  ) +
  geom_point(
    mapping=aes(color=env_condition),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  scale_fill_brewer(
    palette=cb_palette
  ) +
  scale_color_brewer(
    palette=cb_palette
  ) +
  facet_grid(
    COPY_MUT_PROB~env_type_label,
    scales="free_x"
  ) +
  theme(
    legend.position="none",
    axis.text=element_text(size=14),
    panel.border = element_rect(color = "grey", fill=NA, size=1.5)
  )

ggsave(
  paste0(working_directory, "plots/", "entropy_viable_phenotypes_step-1.pdf")
)
```

### 2-step mutants

```{r}
ggplot(
    ls2_run_summary_data,
    aes(
      x=env_chg_rate_label,
      y=entropy_viable_phenotypes,
      fill=env_condition
    )
  ) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8,
    adjust=1.5
  ) +
  geom_point(
    mapping=aes(color=env_condition),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  scale_fill_brewer(
    palette=cb_palette
  ) +
  scale_color_brewer(
    palette=cb_palette
  ) +
  facet_grid(
    COPY_MUT_PROB~env_type_label,
    scales="free_x"
  ) +
  theme(
    legend.position="none",
    axis.text=element_text(size=14),
    panel.border = element_rect(color = "grey", fill=NA, size=1.5)
  )

ggsave(
  paste0(working_directory, "plots/", "entropy_viable_phenotypes_step-2.pdf")
)
```

## Average distance to ancestor

### 1-step mutants

```{r}
ggplot(
    ls1_run_summary_data,
    aes(
      x=env_chg_rate_label,
      y=avg_dist_to_ancestor,
      fill=env_condition
    )
  ) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8,
    adjust=1.5
  ) +
  geom_point(
    mapping=aes(color=env_condition),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  scale_fill_brewer(
    palette=cb_palette
  ) +
  scale_color_brewer(
    palette=cb_palette
  ) +
  facet_grid(
    COPY_MUT_PROB~env_type_label,
    scales="free_x"
  ) +
  theme(
    legend.position="none",
    axis.text=element_text(size=14),
    panel.border = element_rect(color = "grey", fill=NA, size=1.5)
  )

ggsave(
  paste0(working_directory, "plots/", "avg_dist_to_ancestor_step-1.pdf")
)
```

### 2-step mutants

```{r}
ggplot(
    ls2_run_summary_data,
    aes(
      x=env_chg_rate_label,
      y=avg_dist_to_ancestor,
      fill=env_condition
    )
  ) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8,
    adjust=1.5
  ) +
  geom_point(
    mapping=aes(color=env_condition),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  scale_fill_brewer(
    palette=cb_palette
  ) +
  scale_color_brewer(
    palette=cb_palette
  ) +
  facet_grid(
    COPY_MUT_PROB~env_type_label,
    scales="free_x"
  ) +
  theme(
    legend.position="none",
    axis.text=element_text(size=14),
    panel.border = element_rect(color = "grey", fill=NA, size=1.5)
  )

ggsave(
  paste0(working_directory, "plots/", "avg_dist_to_ancestor_step-2.pdf")
)
```

## Number that flip versus proportion that don't change

```{r}
get_num_mutants_same_phenotype <- function(seed) {
  toggle_data <- filter(
    ls2_task_toggle_data,
    (num_tasks_toggled==0) & (RANDOM_SEED == seed)
  )
  return(toggle_data$num_mutants)
}

# ls2_phen_dists_data
get_num_mutants_alt_adapted_phenotype <- function(seed) {
  adapted_data <- filter(
    ls2_phen_dists_data,
    (distance %in% c("0", "1")) & (RANDOM_SEED == seed)
  )
  num_mutants <- sum(adapted_data$count_env_b)
  return(num_mutants)
}

ls2_run_summary_data$num_mutants_same_phenotype <- mapply(
  get_num_mutants_same_phenotype,
  ls2_run_summary_data$RANDOM_SEED
)
ls2_run_summary_data$prop_viable_same_phenotype <- ls2_run_summary_data$num_mutants_same_phenotype / ls2_run_summary_data$num_viable
ls2_run_summary_data$prop_viable_alt_phenotype <- ls2_run_summary_data$num_viable_mutants_flip_env / ls2_run_summary_data$num_viable


ls2_run_summary_data$num_mutants_alt_adapted_phen <- mapply(
  get_num_mutants_alt_adapted_phenotype,
  ls2_run_summary_data$RANDOM_SEED
)
ls2_run_summary_data$prop_viable_alt_adapted_phen <- ls2_run_summary_data$num_mutants_alt_adapted_phen / ls2_run_summary_data$num_viable
ls2_run_summary_data$prop_viable_improve_b_phen <- ls2_run_summary_data$num_viable_mutants_improve_env_b / ls2_run_summary_data$num_viable

ggplot(
    filter(
      ls2_run_summary_data,
      env_type%in%c("cycling")
    ),
    aes(
      x=prop_viable_same_phenotype,
      # y=prop_viable_alt_phenotype,
      # y=num_viable_mutants_improve_env_b / num_viable,
      y=num_mutants_alt_adapted_phen / num_viable,
      fill=COPY_MUT_PROB,
      color=COPY_MUT_PROB
    )
  ) +
  geom_point(
    mapping=aes(
      color=COPY_MUT_PROB,
      fill=COPY_MUT_PROB
    ),
  ) +
  geom_smooth(
    method="lm"
    # fill="#0077ff76"
  ) +
  scale_fill_brewer(
    palette=cb_palette
  ) +
  scale_color_brewer(
    palette=cb_palette
  ) +
  # scale_y_continuous(
  #   trans=pseudo_log_trans(sigma=1,base=10)
    # breaks=c(0, 10, 100, 1000, 10000, 100000, 1000000)
  # ) +
  # scale_x_continuous(
  #   trans=pseudo_log_trans(sigma=1,base=10)
  #   # breaks=c(0, 10, 100, 1000, 10000, 100000, 1000000)
  # ) +
  facet_wrap(
    ~env_type
  ) +
  theme(
    legend.position="bottom",
    axis.text=element_text(size=14),
    axis.text.x=element_text(angle=45,hjust=1)
    # panel.border = element_rect(color = "grey", fill=NA, size=1.5)
  )
ggsave(
  paste0(plot_directory, "prop_alt_adapted_vs_prop_same_phen-2.pdf")
)
```

```{r}
temp_data <- pivot_longer(
  ls2_run_summary_data,
  cols=c(
    "prop_viable_improve_b_phen",
    "prop_viable_alt_adapted_phen"
  ),
  names_to="improvement_level",
  values_to="prop"
)

ggplot(
    filter(
      temp_data,
      env_type%in%c("cycling")
    ),
    aes(
      x=prop_viable_same_phenotype,
      # y=prop_viable_alt_phenotype,
      # y=num_viable_mutants_improve_env_b / num_viable,
      y=prop,
      linetype=improvement_level,
      fill=COPY_MUT_PROB,
      color=COPY_MUT_PROB
    )
  ) +
  geom_point(
    mapping=aes(
      color=COPY_MUT_PROB,
      fill=COPY_MUT_PROB,
      shape=improvement_level
    ),
  ) +
  geom_smooth(
    method="lm"
    # fill="#0077ff76"
  ) +
  scale_fill_brewer(
    palette=cb_palette
  ) +
  scale_color_brewer(
    palette=cb_palette
  ) +
  facet_wrap(
    ~env_type
  ) +
  theme(
    legend.position="bottom",
    axis.text=element_text(size=14),
    axis.text.x=element_text(angle=45,hjust=1)
    # panel.border = element_rect(color = "grey", fill=NA, size=1.5)
  )
ggsave(
  paste0(plot_directory, "out.pdf")
)
```

## Number of viable mutants that gain tasks

## 1-step mutants

```{r}
ggplot(
    ls1_run_summary_data,
    aes(
      x=env_chg_rate_label,
      y=num_viable_mutants_gain_tasks,
      fill=env_condition
    )
  ) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8,
    adjust=1.5
  ) +
  geom_point(
    mapping=aes(color=env_condition),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  scale_fill_brewer(
    palette=cb_palette
  ) +
  scale_color_brewer(
    palette=cb_palette
  ) +
  facet_grid(
    COPY_MUT_PROB~env_type_label,
    scales="free_x"
  ) +
  theme(
    legend.position="none",
    axis.text=element_text(size=14),
    panel.border = element_rect(color = "grey", fill=NA, size=1.5)
  )

ggsave(
  paste0(working_directory, "plots/", "num_viable_mutants_gain_tasks_step-1.pdf")
)
```

### 2-step mutants

```{r}
ggplot(
    ls2_run_summary_data,
    aes(
      x=env_chg_rate_label,
      y=num_viable_mutants_gain_tasks,
      fill=env_condition
    )
  ) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8,
    adjust=1.5
  ) +
  geom_point(
    mapping=aes(color=env_condition),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  scale_fill_brewer(
    palette=cb_palette
  ) +
  scale_color_brewer(
    palette=cb_palette
  ) +
  facet_grid(
    COPY_MUT_PROB~env_type_label,
    scales="free_x"
  ) +
  theme(
    legend.position="none",
    axis.text=element_text(size=14),
    panel.border = element_rect(color = "grey", fill=NA, size=1.5)
  )

ggsave(
  paste0(working_directory, "plots/", "num_viable_mutants_gain_tasks_step-2.pdf")
)
```

## Number of viable mutants that lose tasks

## 1-step mutants

```{r}
ggplot(
    ls1_run_summary_data,
    aes(
      x=env_chg_rate_label,
      y=num_viable_mutants_lose_tasks,
      fill=env_condition
    )
  ) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8,
    adjust=1.5
  ) +
  geom_point(
    mapping=aes(color=env_condition),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  scale_fill_brewer(
    palette=cb_palette
  ) +
  scale_color_brewer(
    palette=cb_palette
  ) +
  facet_grid(
    COPY_MUT_PROB~env_type_label,
    scales="free_x"
  ) +
  theme(
    legend.position="none",
    axis.text=element_text(size=14),
    panel.border = element_rect(color = "grey", fill=NA, size=1.5)
  )

ggsave(
  paste0(working_directory, "plots/", "num_viable_mutants_lose_tasks_step-1.pdf")
)
```

### 2-step mutants

```{r}
ggplot(
    ls2_run_summary_data,
    aes(
      x=env_chg_rate_label,
      y=num_viable_mutants_lose_tasks,
      fill=env_condition
    )
  ) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8,
    adjust=1.5
  ) +
  geom_point(
    mapping=aes(color=env_condition),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  scale_fill_brewer(
    palette=cb_palette
  ) +
  scale_color_brewer(
    palette=cb_palette
  ) +
  facet_grid(
    COPY_MUT_PROB~env_type_label,
    scales="free_x"
  ) +
  theme(
    legend.position="none",
    axis.text=element_text(size=14),
    panel.border = element_rect(color = "grey", fill=NA, size=1.5)
  )

ggsave(
  paste0(working_directory, "plots/", "num_viable_mutants_lose_tasks_step-2.pdf")
)
```

## num_viable_mutants_lose_multiple_tasks

### 1-step mutants

```{r}
ggplot(
    ls1_run_summary_data,
    aes(
      x=env_chg_rate_label,
      y=num_viable_mutants_lose_multiple_tasks,
      fill=env_condition
    )
  ) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8,
    adjust=1.5
  ) +
  geom_point(
    mapping=aes(color=env_condition),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  scale_fill_brewer(
    palette=cb_palette
  ) +
  scale_color_brewer(
    palette=cb_palette
  ) +
  facet_grid(
    COPY_MUT_PROB~env_type_label,
    scales="free_x"
  ) +
  theme(
    legend.position="none",
    axis.text=element_text(size=14),
    panel.border = element_rect(color = "grey", fill=NA, size=1.5)
  )

ggsave(
  paste0(working_directory, "plots/", "num_viable_mutants_lose_multiple_tasks_step-1.pdf")
)
```

### 2-step mutants

```{r}
ggplot(
    ls2_run_summary_data,
    aes(
      x=env_chg_rate_label,
      y=num_viable_mutants_lose_multiple_tasks,
      fill=env_condition
    )
  ) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8,
    adjust=1.5
  ) +
  geom_point(
    mapping=aes(color=env_condition),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  scale_fill_brewer(
    palette=cb_palette
  ) +
  scale_color_brewer(
    palette=cb_palette
  ) +
  facet_grid(
    COPY_MUT_PROB~env_type_label,
    scales="free_x"
  ) +
  theme(
    legend.position="none",
    axis.text=element_text(size=14),
    panel.border = element_rect(color = "grey", fill=NA, size=1.5)
  )

ggsave(
  paste0(working_directory, "plots/", "num_viable_mutants_lose_multiple_tasks_step-2.pdf")
)
```

## Average number of tasks lost

(when tasks are lost)

### 1-step mutants
```{r}
ggplot(
    ls1_run_summary_data,
    aes(
      x=env_chg_rate_label,
      y=avg_num_tasks_lost,
      fill=env_condition
    )
  ) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8,
    adjust=1.5
  ) +
  geom_point(
    mapping=aes(color=env_condition),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  scale_fill_brewer(
    palette=cb_palette
  ) +
  scale_color_brewer(
    palette=cb_palette
  ) +
  facet_grid(
    COPY_MUT_PROB~env_type_label,
    scales="free_x"
  ) +
  theme(
    legend.position="none",
    axis.text=element_text(size=14),
    panel.border = element_rect(color = "grey", fill=NA, size=1.5)
  )

ggsave(
  paste0(working_directory, "plots/", "avg_num_tasks_lost_step-1.pdf")
)
```

### 2-step mutants

```{r}
ggplot(
    ls2_run_summary_data,
    aes(
      x=env_chg_rate_label,
      y=avg_num_tasks_lost,
      fill=env_condition
    )
  ) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8,
    adjust=1.5
  ) +
  geom_point(
    mapping=aes(color=env_condition),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  scale_fill_brewer(
    palette=cb_palette
  ) +
  scale_color_brewer(
    palette=cb_palette
  ) +
  facet_grid(
    COPY_MUT_PROB~env_type_label,
    scales="free_x"
  ) +
  theme(
    legend.position="none",
    axis.text=element_text(size=14),
    panel.border = element_rect(color = "grey", fill=NA, size=1.5)
  )

ggsave(
  paste0(working_directory, "plots/", "avg_num_tasks_lost_step-2.pdf")
)
```

## Total NPMI

total_npmi

### 1-step mutants
```{r}
ggplot(
    ls1_run_summary_data,
    aes(
      x=env_chg_rate_label,
      y=total_npmi,
      fill=env_condition
    )
  ) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8,
    adjust=1.5
  ) +
  geom_point(
    mapping=aes(color=env_condition),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  scale_fill_brewer(
    palette=cb_palette
  ) +
  scale_color_brewer(
    palette=cb_palette
  ) +
  facet_grid(
    COPY_MUT_PROB~env_type_label,
    scales="free_x"
  ) +
  theme(
    legend.position="none",
    axis.text=element_text(size=14),
    panel.border = element_rect(color = "grey", fill=NA, size=1.5)
  )

ggsave(
  paste0(working_directory, "plots/", "total_npmi_step-1.pdf")
)
```

### 2-step mutants

```{r}
ggplot(
    ls2_run_summary_data,
    aes(
      x=env_chg_rate_label,
      y=total_npmi,
      fill=env_condition
    )
  ) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8,
    adjust=1.5
  ) +
  geom_point(
    mapping=aes(color=env_condition),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  scale_fill_brewer(
    palette=cb_palette
  ) +
  scale_color_brewer(
    palette=cb_palette
  ) +
  facet_grid(
    COPY_MUT_PROB~env_type_label,
    scales="free_x"
  ) +
  theme(
    legend.position="none",
    axis.text=element_text(size=14),
    panel.border = element_rect(color = "grey", fill=NA, size=1.5)
  )

ggsave(
  paste0(working_directory, "plots/", "total_npmi_step-2.pdf")
)
```

## Final mutation rate vs npmi

```{r}
ggplot(
    filter(
      ls2_run_summary_data
    ),
    aes(
      x=total_npmi,
      y=final_average_copy_mutation_rate
      # fill=env_condition
    )
  ) +
  geom_point(
    # mapping=aes(color=env_condition)
    # position = position_jitter(width = .15)
  ) +
  geom_smooth(
    method="lm"
  ) +
  geom_hline(
    yintercept=0,
    linetype="dashed",
    size=0.5
  ) +
  facet_grid(
    COPY_MUT_PROB~env_type_label,
    scales="free_x"
  ) +
  theme(
    legend.position="none",
    axis.text=element_text(size=14),
    # axis.text.x = element_text(angle = 90),
    panel.border = element_rect(color = "grey", fill=NA, size=1.5)
  )

ggsave(
  paste0(working_directory, "plots/", "total_npmi_vs_final_mut_rate_step-2.pdf")
)
```

## Total unexpected NPMI

### 1-step mutants

```{r}
ggplot(
    ls1_run_summary_data,
    aes(
      x=env_chg_rate_label,
      y=unexpected_npmi,
      fill=env_condition
    )
  ) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8,
    adjust=1.5
  ) +
  geom_point(
    mapping=aes(color=env_condition),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  scale_fill_brewer(
    palette=cb_palette
  ) +
  scale_color_brewer(
    palette=cb_palette
  ) +
  facet_grid(
    COPY_MUT_PROB~env_type_label,
    scales="free_x"
  ) +
  theme(
    legend.position="none",
    axis.text=element_text(size=14),
    panel.border = element_rect(color = "grey", fill=NA, size=1.5)
  )

ggsave(
  paste0(working_directory, "plots/", "unexpected_npmi_step-1.pdf")
)
```

### 2-step mutants

```{r}
ggplot(
    ls2_run_summary_data,
    aes(
      x=env_chg_rate_label,
      y=unexpected_npmi,
      fill=env_condition
    )
  ) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8,
    adjust=1.5
  ) +
  geom_point(
    mapping=aes(color=env_condition),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  scale_fill_brewer(
    palette=cb_palette
  ) +
  scale_color_brewer(
    palette=cb_palette
  ) +
  facet_grid(
    COPY_MUT_PROB~env_type_label,
    scales="free_x"
  ) +
  theme(
    legend.position="none",
    axis.text=element_text(size=14),
    panel.border = element_rect(color = "grey", fill=NA, size=1.5)
  )

ggsave(
  paste0(working_directory, "plots/", "unexpected_npmi_step-2.pdf")
)
```

## Total expected NPMI

### 1-step mutants

```{r}
ggplot(
    ls1_run_summary_data,
    aes(
      x=env_chg_rate_label,
      y=expected_npmi,
      fill=env_condition
    )
  ) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8,
    adjust=1.5
  ) +
  geom_point(
    mapping=aes(color=env_condition),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  scale_fill_brewer(
    palette=cb_palette
  ) +
  scale_color_brewer(
    palette=cb_palette
  ) +
  facet_grid(
    COPY_MUT_PROB~env_type_label,
    scales="free_x"
  ) +
  theme(
    legend.position="none",
    axis.text=element_text(size=14),
    panel.border = element_rect(color = "grey", fill=NA, size=1.5)
  )

ggsave(
  paste0(working_directory, "plots/", "expected_npmi_step-1.pdf")
)
```

### 2-step mutants

```{r}
ggplot(
    ls2_run_summary_data,
    aes(
      x=env_chg_rate_label,
      y=expected_npmi,
      fill=env_condition
    )
  ) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8,
    adjust=1.5
  ) +
  geom_point(
    mapping=aes(color=env_condition),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  scale_fill_brewer(
    palette=cb_palette
  ) +
  scale_color_brewer(
    palette=cb_palette
  ) +
  facet_grid(
    COPY_MUT_PROB~env_type_label,
    scales="free_x"
  ) +
  theme(
    legend.position="none",
    axis.text=element_text(size=14),
    panel.border = element_rect(color = "grey", fill=NA, size=1.5)
  )

ggsave(
  paste0(working_directory, "plots/", "expected_npmi_step-2.pdf")
)
```

## Pointwise mutual information matrices

### 1-step mutants

```{r}
ggplot(
    ls1_cooccur_data,
    aes(
      x=task_1_id,
      y=task_2_id,
      fill=npmi_avg
    )
  ) +
  geom_tile() +
  scale_fill_distiller(
    palette = "RdBu",
    limits=c(-1.0, 1.0),
    breaks=c(-1, -0.5, 0.0, 0.5, 1.0)
  ) +
  facet_grid(
    env_condition~COPY_MUT_PROB
  ) +
  ggtitle("One-step Mutants") +
  theme(
    legend.position="bottom",
    strip.text.y=element_text(size=10),
    legend.key.width=unit(3, "cm")
  )
ggsave(
  paste0(working_directory, "plots/", "npmi_matrices_step-1.pdf"),
  height=15,
  width=12
)
```

### 2-step mutants

```{r}
ggplot(
    ls2_cooccur_data,
    aes(
      x=task_1_id,
      y=task_2_id,
      fill=npmi_avg
    )
  ) +
  geom_tile() +
  scale_fill_distiller(
    palette = "RdBu",
    limits=c(-1.0, 1.0),
    breaks=c(-1, -0.5, 0.0, 0.5, 1.0)
  ) +
  facet_grid(
    env_condition~COPY_MUT_PROB
  ) +
  ggtitle("Two-step Mutants") +
  theme(
    legend.position="bottom",
    strip.text.y=element_text(size=10),
    legend.key.width=unit(3, "cm")
  )
ggsave(
  paste0(working_directory, "plots/", "npmi_matrices_step-2.pdf"),
  height=15,
  width=12
)
```

## Distribution of mutant phenotypes

### 1-step mutants

```{r}
ggplot(
    # filter(ls1_phen_dists_data, env_condition=="env-consta"),
    ls1_phen_dists_data,
    aes(
      x=rep_id,
      y=count_env_a,
      fill=distance
    )
  ) +
  geom_bar(position="stack", stat="identity") +
  scale_fill_viridis(discrete=TRUE, direction=-1) +
  facet_grid(
    env_condition~COPY_MUT_PROB,
    scales="free_x"
  ) +
  theme(
    legend.position="bottom",
    axis.text.x=element_text(size=10)
  )
ggsave(
  paste0(working_directory, "plots/", "mutant_phen_dist_env_a_step-1.pdf"),
  width=15,
  height=18
)

```

### 2-step mutants

```{r}
ggplot(
    # filter(ls1_phen_dists_data, env_condition=="env-consta"),
    ls2_phen_dists_data,
    aes(
      x=rep_id,
      y=count_env_a,
      fill=distance
    )
  ) +
  geom_bar(position="stack", stat="identity") +
  scale_fill_viridis(discrete=TRUE, direction=-1) +
  facet_grid(
    env_condition~COPY_MUT_PROB,
    scales="free_x"
  ) +
  theme(
    legend.position="bottom",
    axis.text.x=element_text(size=10)
  )
ggsave(
  paste0(working_directory, "plots/", "mutant_phen_dist_env_a_step-2.pdf"),
  width=15,
  height=18
)
```

## Distance N away from env-A

```{r}
ggplot(
    filter(
      ls2_phen_dists_data,
      (distance==0) & env_chg_rate_label!="none-b" & dom_match_score_env_a==6
    ),
    aes(
      x=env_chg_rate_label,
      y=count_env_b,
      fill=env_condition
    )
  ) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8,
    adjust=1.5
  ) +
  geom_point(
    mapping=aes(color=env_condition),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  geom_hline(
    yintercept=0,
    linetype="dashed",
    size=0.5
  ) +
  scale_fill_brewer(
    palette=cb_palette
  ) +
  scale_color_brewer(
    palette=cb_palette
  ) +
  scale_y_continuous(
    trans=pseudo_log_trans(sigma=1,base=10),
    breaks=c(0, 10, 100, 1000, 10000, 100000)
  ) +
  facet_grid(
    COPY_MUT_PROB~env_type_label,
    scales="free_x"
  ) +
  theme(
    legend.position="none",
    axis.text=element_text(size=14),
    panel.border = element_rect(color = "grey", fill=NA, size=1.5)
  )

ggsave(
  paste0(working_directory, "plots/", "mutants_dist-6_env-a_step-2.pdf")
)
```

```{r}
ggplot(
    filter(
      ls2_phen_dists_data,
      (distance==6) & env_chg_rate_label!="none-b" & dom_match_score_env_a==6
    ),
    aes(
      x=env_chg_rate_label,
      y=count_env_b,
      fill=env_condition
    )
  ) +
  geom_flat_violin(
    position = position_nudge(x = .2, y = 0),
    alpha = .8,
    adjust=1.5
  ) +
  geom_point(
    mapping=aes(color=env_condition),
    position = position_jitter(width = .15),
    size = .5,
    alpha = 0.8
  ) +
  geom_boxplot(
    width = .1,
    outlier.shape = NA,
    alpha = 0.5
  ) +
  geom_hline(
    yintercept=0,
    linetype="dashed",
    size=0.5
  ) +
  scale_fill_brewer(
    palette=cb_palette
  ) +
  scale_color_brewer(
    palette=cb_palette
  ) +
  # scale_y_continuous(
  #   trans=pseudo_log_trans(sigma=1,base=10),
  #   breaks=c(0, 10, 100, 1000, 10000, 100000)
  # ) +
  facet_grid(
    env_type_label~COPY_MUT_PROB,
    scales="free_x"
  ) +
  theme(
    legend.position="none",
    axis.text=element_text(size=14),
    panel.border = element_rect(color = "grey", fill=NA, size=1.5)
  )

ggsave(
  paste0(working_directory, "plots/", "mutants_dist-0_env-a_step-2.pdf")
)
```